<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookleaf – Author–Consultant Tracker</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="header-left">
        <h1>Bookleaf – Author–Consultant Tracker</h1>
        <p class="subtitle">Publishing consultant assignments &middot; Workflow tracking &middot; Freshdesk integration &middot; Razorpay Webhook &middot; Slot Booking</p>
      </div>
      <div class="header-right">
        <div class="identity-selector">
          <label class="identity-label">Viewing as:</label>
          <select id="identity-select" class="identity-dropdown">
            <option value="admin">All Authors (Admin)</option>
            <option value="Vandana">Vandana Pradhan</option>
            <option value="Sapna">Sapna Kumari</option>
            <option value="Tannu">Tannu Tiwari</option>
            <option value="Roosha">Roosha</option>
            <option value="Firdaus">Firdaus (Resigned)</option>
          </select>
          <span id="identity-badge" class="identity-badge identity-admin">Admin View</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Stats -->
    <section id="stats" class="stats-row">
      <div class="stat-card"><span class="stat-value" id="stat-authors">0</span><span class="stat-label">Authors</span></div>
      <div class="stat-card accent-indian"><span class="stat-value" id="stat-indian">0</span><span class="stat-label">Indian Bestseller</span></div>
      <div class="stat-card accent-intl"><span class="stat-value" id="stat-intl">0</span><span class="stat-label">Intl Bestseller</span></div>
      <div class="stat-card accent-fd"><span class="stat-value" id="stat-tickets">0</span><span class="stat-label">FD Tickets</span></div>
      <div class="stat-card accent-good"><span class="stat-value" id="stat-good">0</span><span class="stat-label">Good to Go</span></div>
      <div class="stat-card"><span class="stat-value" id="stat-assigned">0</span><span class="stat-label">Assigned</span></div>
    </section>

    <!-- Consultant Workload -->
    <section id="workload-section" class="card">
      <h2>Consultant Workload</h2>
      <div id="workload-grid" class="workload-grid">
        <p class="placeholder-text">Loading...</p>
      </div>
    </section>

    <!-- Author Assignments Table -->
    <section id="assignments-section" class="card">
      <h2>Author Assignments &amp; Workflow</h2>
      <div class="table-controls">
        <input type="text" id="search-input" placeholder="Search author, email, consultant..." class="search-input">
        <select id="filter-package" class="filter-select">
          <option value="all">All Packages</option>
          <option value="indian">Indian Bestseller</option>
          <option value="intl">Intl Bestseller</option>
        </select>
        <select id="filter-consultant" class="filter-select">
          <option value="all">All Consultants</option>
          <option value="Vandana">Vandana</option>
          <option value="Sapna">Sapna</option>
          <option value="Tannu">Tannu</option>
          <option value="Roosha">Roosha</option>
          <option value="Firdaus">Firdaus (Resigned)</option>
        </select>
        <select id="filter-status" class="filter-select">
          <option value="all">All Statuses</option>
          <option value="assigned">Assigned</option>
          <option value="in-progress">In Progress</option>
          <option value="good-to-go">Good to Go</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="table-wrapper">
        <table id="assignments-table">
          <thead>
            <tr>
              <th>Author</th>
              <th>Email</th>
              <th>Package</th>
              <th>Date</th>
              <th>Consultant</th>
              <th>Intro Email</th>
              <th>Author Resp.</th>
              <th>Follow-up</th>
              <th>Marked Yes</th>
              <th>Status</th>
              <th>Files Gen.</th>
              <th>Addr &amp; Mktg</th>
              <th>Prime Place.</th>
              <th>Confirm Email</th>
              <th>Remarks</th>
              <th>FD</th>
            </tr>
          </thead>
          <tbody id="assignments-body">
            <tr class="empty-row"><td colspan="16">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Actions -->
    <section class="actions-row">
      <button id="btn-export" class="btn btn-secondary" disabled>Export CSV</button>
      <button id="btn-auto-assign" class="btn btn-primary" disabled>Re-Assign New Authors (Round Robin)</button>
      <button id="btn-clear-assignments" class="btn btn-danger" disabled>Clear All Assignments</button>
    </section>

    <!-- Admin Tools (collapsible) -->
    <details class="admin-section">
      <summary class="admin-toggle">Admin Tools</summary>
      <div class="config-row">
        <section id="import-panel" class="card">
          <h2>Data Import</h2>
          <div class="config-form">
            <div class="field">
              <div class="file-upload-area" id="drop-zone">
                <input type="file" id="csv-file" accept=".csv">
                <p>Click or drag &amp; drop Razorpay CSV export</p>
              </div>
            </div>
            <div class="field">
              <label>Filter by Package</label>
              <div class="checkbox-row">
                <label class="checkbox-label"><input type="checkbox" id="filter-indian" checked> Indian Bestseller</label>
                <label class="checkbox-label"><input type="checkbox" id="filter-intl" checked> Intl Bestseller</label>
              </div>
            </div>
            <div class="field">
              <label>Manual Tracker Override</label>
              <div class="tracker-upload-row">
                <select id="tracker-consultant" class="filter-select">
                  <option value="Vandana">Vandana</option>
                  <option value="Sapna">Sapna</option>
                  <option value="Tannu">Tannu</option>
                  <option value="Roosha">Roosha</option>
                  <option value="Firdaus">Firdaus</option>
                </select>
                <input type="file" id="tracker-csv" accept=".csv" class="tracker-file-input">
                <button id="btn-load-tracker" class="btn btn-secondary btn-sm">Load Tracker</button>
              </div>
              <div id="tracker-status" class="status-msg hidden"></div>
              <div id="tracker-loaded" class="tracker-tags"></div>
            </div>
            <div class="btn-row">
              <button id="btn-import" class="btn btn-primary" disabled>Import CSV &amp; Auto-Assign</button>
              <button id="btn-load-sample" class="btn btn-secondary">Sample Data</button>
            </div>
            <div id="api-status" class="status-msg hidden"></div>
            <p class="info-text" style="margin-top:4px">Upload Razorpay CSV export or use Sample Data. New authors are auto-assigned via round-robin.</p>
          </div>
        </section>

        <section id="freshdesk-panel" class="card">
          <h2>Freshdesk Integration</h2>
          <div class="config-form">
            <div class="field">
              <label>Freshdesk API Key</label>
              <input type="password" id="fd-api-key" placeholder="Paste your Freshdesk API key here">
            </div>
            <div class="field">
              <label>Domain</label>
              <input type="text" id="fd-domain" value="bookleafpublishing.freshdesk.com" readonly class="readonly-input">
            </div>
            <div class="btn-row">
              <button id="btn-fd-fetch" class="btn btn-primary" disabled>Fetch &amp; Sync Tickets</button>
              <button id="btn-fd-auto-assign" class="btn btn-accent" disabled>Auto-Assign Tickets</button>
            </div>
            <div id="fd-status" class="status-msg hidden"></div>
            <div class="fd-info">
              <p class="info-text">Tickets auto-match to authors by email. Resolved tickets auto-mark authors as "Good to Go".</p>
            </div>
          </div>
        </section>
      </div>
    </details>

    <!-- Razorpay Webhook Section -->
    <details class="admin-section">
      <summary class="admin-toggle">Razorpay Webhook</summary>
      <div class="webhook-content">
        <section class="card">
          <h2>Razorpay Webhook Listener</h2>
          <div class="config-form">
            <div class="field">
              <label>Webhook Secret</label>
              <input type="password" id="rp-webhook-secret" placeholder="Paste your Razorpay webhook secret here">
            </div>
            <div class="webhook-info-box">
              <p class="info-text"><strong>Setup:</strong> In your Razorpay Dashboard &rarr; Settings &rarr; Webhooks, add a new webhook pointing to your server endpoint. Select <code>payment.captured</code> event.</p>
              <p class="info-text" style="margin-top:4px">Webhook events are processed below. New authors from captured payments are auto-assigned via round-robin.</p>
            </div>
            <div class="btn-row">
              <button id="btn-webhook-simulate" class="btn btn-secondary">Simulate Webhook Event</button>
              <button id="btn-webhook-clear" class="btn btn-danger btn-sm">Clear Log</button>
            </div>
            <div id="webhook-status" class="status-msg hidden"></div>
            <div class="field" style="margin-top:8px">
              <label>Paste Webhook Payload (JSON)</label>
              <textarea id="webhook-payload" class="webhook-textarea" rows="5" placeholder='{"event":"payment.captured","payload":{"payment":{"entity":{...}}}}'></textarea>
            </div>
            <div class="btn-row">
              <button id="btn-webhook-process" class="btn btn-primary" disabled>Process Webhook Payload</button>
            </div>
          </div>
          <div class="webhook-log-section" style="margin-top:16px">
            <h3 style="font-size:0.9rem;margin-bottom:8px">Webhook Event Log</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Event</th>
                    <th>Author</th>
                    <th>Email</th>
                    <th>Package</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="webhook-log-body">
                  <tr class="empty-row"><td colspan="7">No webhook events received yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </details>

    <!-- Consultant Booking Links & Tracking -->
    <details class="admin-section" id="callback-section">
      <summary class="admin-toggle">Consultant Booking Links</summary>
      <div class="callback-content">
        <!-- Booking Overview -->
        <section class="card">
          <h2>Booking Overview</h2>
          <p class="info-text" style="margin:-8px 0 12px">Generate a shareable booking link for each author. Authors can pick a slot (10 AM – 6 PM, Mon–Sat) and confirm. Track all bookings below.</p>
          <div class="call-overview-stats" id="call-overview-stats"></div>
        </section>

        <!-- Author Booking Tracker Table -->
        <section class="card" style="margin-top:0">
          <h2>Author Booking Tracker</h2>
          <div class="table-controls">
            <input type="text" id="call-search" placeholder="Search authors..." class="search-input">
            <select id="call-filter-status" class="filter-select">
              <option value="all">All Statuses</option>
              <option value="pending">No Booking</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <select id="call-filter-consultant" class="filter-select">
              <option value="all">All Consultants</option>
              <option value="Vandana">Vandana</option>
              <option value="Sapna">Sapna</option>
              <option value="Tannu">Tannu</option>
              <option value="Roosha">Roosha</option>
            </select>
            <button id="btn-call-export" class="btn btn-secondary btn-sm">Export Bookings</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Author</th>
                  <th>Email</th>
                  <th>Consultant</th>
                  <th>Booking</th>
                  <th>Date &amp; Time</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="call-tracker-body">
                <tr class="empty-row"><td colspan="7">No author data loaded.</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </details>

    <!-- Author Callback Response Form (shown only when ?callback=true) -->
    <section id="author-callback-view" class="hidden">
      <div class="author-callback-container">
        <div class="author-callback-header">
          <h1>Bookleaf Publishing</h1>
          <p class="author-callback-subtitle" id="acb-subtitle">Callback Scheduling</p>
        </div>
        <div class="author-callback-card">
          <h2 id="acb-greeting">Hello!</h2>
          <p id="acb-description" class="acb-desc"></p>
          <div class="acb-form" id="acb-form">
            <div class="field">
              <label>Your Name</label>
              <input type="text" id="acb-name" readonly class="readonly-input">
            </div>
            <div class="field">
              <label>Your Email</label>
              <input type="text" id="acb-email" readonly class="readonly-input">
            </div>
            <div class="field">
              <label>Phone Number</label>
              <input type="text" id="acb-phone" placeholder="+91XXXXXXXXXX">
            </div>
            <div class="field">
              <label>Availability</label>
              <div class="acb-radio-group">
                <label class="acb-radio"><input type="radio" name="acb-avail" value="available" checked> I am available for this call</label>
                <label class="acb-radio"><input type="radio" name="acb-avail" value="later"> Please contact me later</label>
                <label class="acb-radio"><input type="radio" name="acb-avail" value="specific"> I prefer a specific date/time</label>
              </div>
            </div>
            <div class="field" id="acb-datetime-field" style="display:none">
              <label>Preferred Date &amp; Time</label>
              <div class="date-range-row">
                <input type="date" id="acb-date" class="date-input">
                <input type="time" id="acb-time" class="date-input">
              </div>
            </div>
            <div class="field">
              <label>Notes (optional)</label>
              <textarea id="acb-notes" class="webhook-textarea" rows="3" placeholder="Any specific topics you'd like to discuss..."></textarea>
            </div>
            <div class="btn-row">
              <button id="btn-acb-submit" class="btn btn-primary">Confirm &amp; Notify Consultant</button>
            </div>
            <div id="acb-status" class="status-msg hidden"></div>
          </div>
          <div id="acb-thankyou" class="hidden">
            <h3 style="color:var(--success);margin-bottom:8px">Thank you!</h3>
            <p>Your response has been recorded. Your consultant will be in touch shortly.</p>
            <div id="acb-response-summary" class="acb-summary-box"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Freshdesk Tickets Table -->
    <section id="tickets-section" class="card hidden">
      <h2>Freshdesk Tickets – Author Matches</h2>
      <div class="table-controls">
        <input type="text" id="ticket-search" placeholder="Search tickets..." class="search-input">
        <select id="ticket-filter-match" class="filter-select">
          <option value="all">All Tickets</option>
          <option value="matched">Matched</option>
          <option value="unmatched">Unmatched</option>
        </select>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Ticket #</th>
              <th>Subject</th>
              <th>Requester</th>
              <th>Author</th>
              <th>Consultant</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tickets-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer><p>Internal Tool &middot; Bookleaf Publishing &middot; Author–Consultant Tracker</p></footer>
  <script src="tracker-data.js"></script>
  <script src="authors-data.js"></script>
  <script src="app.js"></script>
</body>
</html>
